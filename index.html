<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Nanocellulose Emulsion Data Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .control-panel label {
            color: #cbd5e1; /* slate-300 */
        }
        .control-panel select, .control-panel input {
            background-color: #334155; /* slate-700 */
            color: #f1f5f9; /* slate-100 */
            border-color: #475569; /* slate-600 */
        }
        .plotly .modebar {
            background-color: transparent !important;
        }
        .plotly .modebar-btn path {
            fill: #94a3b8 !important; /* slate-400 */
        }
        .plot-container {
             background-color: rgba(15, 23, 42, 0.7); /* slate-900 with some transparency */
             border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-5xl font-bold text-white tracking-tight">Nanocellulose Pickering Emulsions</h1>
            <p class="text-lg text-slate-400 mt-2">An Interactive Data Explorer for TAPPI Nano 2025, Girona</p>
        </header>

        <main class="space-y-10">
            <!-- Section 1: Interactive Scatter Plot -->
            <section class="bg-slate-800/50 p-6 rounded-xl shadow-2xl ring-1 ring-white/10">
                <h2 class="text-2xl font-semibold mb-4 text-white border-b border-slate-700 pb-3">1. Multi-Dimensional Property Explorer</h2>
                <div class="control-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <!-- Axis & Color Controls -->
                    <div>
                        <label for="x-axis-select" class="block text-sm font-medium">X-Axis:</label>
                        <select id="x-axis-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="y-axis-select" class="block text-sm font-medium">Y-Axis:</label>
                        <select id="y-axis-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="color-by-select" class="block text-sm font-medium">Color By:</label>
                        <select id="color-by-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <!-- Filtering Controls -->
                    <div>
                        <label for="filter-category-select" class="block text-sm font-medium">Filter Category:</label>
                        <select id="filter-category-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="filter-value-select" class="block text-sm font-medium">Filter Value:</label>
                        <select id="filter-value-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
                 <div class="flex justify-end space-x-4 mb-4">
                    <label class="flex items-center space-x-2 text-sm cursor-pointer">
                        <input type="checkbox" id="log-x-checkbox" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                        <span>Log X-Axis</span>
                    </label>
                     <label class="flex items-center space-x-2 text-sm cursor-pointer">
                        <input type="checkbox" id="log-y-checkbox" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                        <span>Log Y-Axis</span>
                    </label>
                </div>
                 <div id="interactive-scatter" class="w-full h-[600px] plot-container"></div>
            </section>

            <!-- Section 2 & 3: Side-by-Side Plots -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <!-- Distribution Analysis -->
                <section class="bg-slate-800/50 p-6 rounded-xl shadow-2xl ring-1 ring-white/10">
                    <h2 class="text-2xl font-semibold mb-4 text-white border-b border-slate-700 pb-3">2. Droplet Size Distribution</h2>
                     <div class="control-panel grid grid-cols-1 gap-4 mb-6">
                         <div>
                             <label for="dist-category-select" class="block text-sm font-medium">Group By:</label>
                             <select id="dist-category-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                         </div>
                     </div>
                    <div id="distribution-plot" class="w-full h-[500px] plot-container"></div>
                </section>
                
                <!-- Correlation Heatmap -->
                <section class="bg-slate-800/50 p-6 rounded-xl shadow-2xl ring-1 ring-white/10">
                     <h2 class="text-2xl font-semibold mb-4 text-white border-b border-slate-700 pb-3">3. Correlation Matrix</h2>
                     <div id="heatmap-plot" class="w-full h-[552px] plot-container"></div>
                </section>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- UPDATED EXPERIMENTAL DATA SOURCE ---
            const database = [
                {
                    'DOI': '10.1021/la200971f', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 30.0, 'Emulsification_Method': 'Sonication', 'Droplet_Size_um': 4.2, 'Stability_Days': '>60', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'CNC (Bacterial)', 'Modification': 'None', 'Concentration_wt_percent': 0.22,
                    'Particle_L_nm': 855, 'Particle_w_nm': 17, 'Particle_t_nm': 7, 'Aspect_Ratio': 50, 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': '<0.001', 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1021/bm301871k', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 95.0, 'Emulsification_Method': 'High-shear homogenizer', 'Droplet_Size_um': null, 'Stability_Days': '>60', 'Electrolyte_Concentration_mM': 50,
                    'Type_of_Nanocellulose': 'CNC (Cotton)', 'Modification': 'Sulfate groups', 'Concentration_wt_percent': 0.038,
                    'Particle_L_nm': 189, 'Particle_w_nm': 13, 'Particle_t_nm': 6, 'Aspect_Ratio': 15, 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': 0.123, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1021/bm400854n', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Toluene', 'Oil_Content_vol_percent': 50.0, 'Emulsification_Method': 'Sonication', 'Droplet_Size_um': 25.0, 'Stability_Days': '>60', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'CNC (Cotton)', 'Modification': 'Vinyl Acetate', 'Concentration_wt_percent': 0.36,
                    'Particle_L_nm': 206, 'Particle_w_nm': null, 'Particle_t_nm': 9, 'Aspect_Ratio': null, 'Crystallinity_Index': 0.92,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1021/bm400854n', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Cyclohexane', 'Oil_Content_vol_percent': 50.0, 'Emulsification_Method': 'Sonication', 'Droplet_Size_um': 20.0, 'Stability_Days': '>60', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'CNC (Cotton)', 'Modification': 'Vinyl Cinnamate', 'Concentration_wt_percent': 0.38,
                    'Particle_L_nm': 407, 'Particle_w_nm': null, 'Particle_t_nm': 7, 'Aspect_Ratio': null, 'Crystallinity_Index': 0.90,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1039/c2sm26472b', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 10.0, 'Emulsification_Method': 'Sonication', 'Droplet_Size_um': 5.0, 'Stability_Days': '>30', 'Electrolyte_Concentration_mM': 50,
                    'Type_of_Nanocellulose': 'CNC (Cotton)', 'Modification': 'Sulfate groups', 'Concentration_wt_percent': 0.2,
                    'Particle_L_nm': 189, 'Particle_w_nm': 13, 'Particle_t_nm': 6, 'Aspect_Ratio': 13, 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': 0.132, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1039/c2sm26472b', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 10.0, 'Emulsification_Method': 'Sonication', 'Droplet_Size_um': 5.0, 'Stability_Days': '>30', 'Electrolyte_Concentration_mM': 50,
                    'Type_of_Nanocellulose': 'CNC (Bacterial)', 'Modification': 'None', 'Concentration_wt_percent': 0.2,
                    'Particle_L_nm': 855, 'Particle_w_nm': 17, 'Particle_t_nm': 7, 'Aspect_Ratio': 47, 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': 0.012, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1039/c2sm26472b', 'Emulsion_Type': 'o/w', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 10.0, 'Emulsification_Method': 'Sonication', 'Droplet_Size_um': 5.0, 'Stability_Days': '>30', 'Electrolyte_Concentration_mM': 50,
                    'Type_of_Nanocellulose': 'CNC (Cladophora)', 'Modification': 'None', 'Concentration_wt_percent': 0.2,
                    'Particle_L_nm': 4000, 'Particle_w_nm': 20, 'Particle_t_nm': 5, 'Aspect_Ratio': 160, 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': 0.018, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1021/la5017577', 'Emulsion_Type': 'w/o', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 80.0, 'Emulsification_Method': 'High-shear homogenizer', 'Droplet_Size_um': 66.0, 'Stability_Days': '>30', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'NFC', 'Modification': 'Lauroyl Chloride', 'Concentration_wt_percent': 0.2,
                    'Particle_L_nm': '>1000', 'Particle_w_nm': 8, 'Particle_t_nm': 7, 'Aspect_Ratio': '>125', 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': 115
                },
                {
                    'DOI': '10.1021/la5017577', 'Emulsion_Type': 'w/o', 'Oil_Type': 'Hexadecane', 'Oil_Content_vol_percent': 80.0, 'Emulsification_Method': 'High-shear homogenizer', 'Droplet_Size_um': 40.0, 'Stability_Days': '>30', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'CNC', 'Modification': 'Lauroyl Chloride', 'Concentration_wt_percent': 0.4,
                    'Particle_L_nm': 134, 'Particle_w_nm': 10, 'Particle_t_nm': 12, 'Aspect_Ratio': 13, 'Crystallinity_Index': null,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': null, 'Contact_Angle_deg': 76
                },
                {
                    'DOI': '10.1021/la4032514', 'Emulsion_Type': 'w/o', 'Oil_Type': 'Toluene', 'Oil_Content_vol_percent': 29.0, 'Emulsification_Method': 'High-shear homogenizer + Hand shaking', 'Droplet_Size_um': null, 'Stability_Days': '>6', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'NFC (Bacterial)', 'Modification': 'Acetic Acid (C2)', 'Concentration_wt_percent': 0.15,
                    'Particle_L_nm': '>2000', 'Particle_w_nm': 50, 'Particle_t_nm': 50, 'Aspect_Ratio': '>40', 'Crystallinity_Index': 0.83,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': 48.3, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1021/la4032514', 'Emulsion_Type': 'w/o', 'Oil_Type': 'Toluene', 'Oil_Content_vol_percent': 19.0, 'Emulsification_Method': 'High-shear homogenizer + Hand shaking', 'Droplet_Size_um': 25.0, 'Stability_Days': '>6', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'NFC (Bacterial)', 'Modification': 'Hexanoic Acid (C6)', 'Concentration_wt_percent': 0.1,
                    'Particle_L_nm': '>2000', 'Particle_w_nm': 50, 'Particle_t_nm': 50, 'Aspect_Ratio': '>40', 'Crystallinity_Index': 0.90,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': 71.5, 'Contact_Angle_deg': null
                },
                {
                    'DOI': '10.1021/la4032514', 'Emulsion_Type': 'w/o', 'Oil_Type': 'Toluene', 'Oil_Content_vol_percent': 23.0, 'Emulsification_Method': 'High-shear homogenizer + Hand shaking', 'Droplet_Size_um': null, 'Stability_Days': '>6', 'Electrolyte_Concentration_mM': 0,
                    'Type_of_Nanocellulose': 'NFC (Bacterial)', 'Modification': 'Dodecanoic Acid (C12)', 'Concentration_wt_percent': 0.12,
                    'Particle_L_nm': '>2000', 'Particle_w_nm': 50, 'Particle_t_nm': 50, 'Aspect_Ratio': '>40', 'Crystallinity_Index': 0.85,
                    'Zeta_Potential_mV': null, 'Surface_Charge_Density_e_nm2': null, 'Surface_Energy_mJ_m2': 53.4, 'Contact_Angle_deg': 133
                }
            ];

            // --- ENRICHED PUBLICATION DATA ---
            const publicationData = [
                {"DOI":"10.1021/la200971f", "Title":"New Pickering Emulsions Stabilized by Bacterial Cellulose Nanocrystals", "Authors":"Kalashnikova, I., et al.", "Publication_Year":2011},
                {"DOI":"10.1021/bm301871k", "Title":"Surfactant-Free High Internal Phase Emulsions Stabilized by Cellulose Nanocrystals", "Authors":"Capron, I., et al.", "Publication_Year":2013},
                {"DOI":"10.1021/bm400854n", "Title":"Dispersibility and Emulsion-Stabilizing Effect of Cellulose Nanowhiskers Esterified by Vinyl Acetate and Vinyl Cinnamate", "Authors":"Sèbe, G., et al.", "Publication_Year":2013},
                {"DOI":"10.1039/c2sm26472b", "Title":"Cellulosic nanorods of various aspect ratios for oil in water Pickering emulsions", "Authors":"Kalashnikova, I., et al.", "Publication_Year":2013},
                {"DOI":"10.1021/la5017577", "Title":"Preparation of Double Pickering Emulsions Stabilized by Chemically Tailored Nanocelluloses", "Authors":"Cunha, A. G., et al.", "Publication_Year":2014},
                {"DOI":"10.1021/la4032514", "Title":"Phase Behavior of Medium and High Internal Phase Water-in-Oil Emulsions Stabilized Solely by Hydrophobized Bacterial Cellulose Nanofibrils", "Authors":"Lee, K.-Y., et al.", "Publication_Year":2014}
            ];


            // --- DATA PROCESSING & SETUP ---
            let processedData = [];
            const numericalCols = [
                'Oil_Content_vol_percent', 'Droplet_Size_um', 'Electrolyte_Concentration_mM', 
                'Concentration_wt_percent', 'Particle_L_nm', 'Particle_w_nm', 'Particle_t_nm', 
                'Aspect_Ratio', 'Crystallinity_Index', 'Zeta_Potential_mV', 
                'Surface_Charge_Density_e_nm2', 'Surface_Energy_mJ_m2', 'Contact_Angle_deg',
                'Publication_Year'
            ];
            const categoricalCols = [
                'Emulsion_Type', 'Oil_Type', 'Emulsification_Method', 'Stability_Days',
                'Type_of_Nanocellulose', 'Modification', 'Cellulose_Type', 'Cellulose_Source'
            ];
            
            function getMedian(arr) {
                if (!arr || arr.length === 0) return 0;
                const sorted = arr.map(v => parseFloat(String(v).replace('>', ''))).filter(v => v !== null && !isNaN(v)).slice().sort((a, b) => a - b);
                if (sorted.length === 0) return 0;
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            }

            function preprocessData(db, pubData) {
                const pubMap = new Map(pubData.map(p => [p.DOI, p]));

                // Calculate medians for imputation, handling string values like '>60'
                const medianDroplet = getMedian(db.map(d => d.Droplet_Size_um));
                const medianAspectRatio = getMedian(db.map(d => d.Aspect_Ratio));

                return db.map(d => {
                    const pubInfo = pubMap.get(d.DOI) || {};
                    let rawType = d.Type_of_Nanocellulose || '';
                    rawType = rawType.replace('NFC', 'CNF');
                    
                    let celluloseType = 'Unknown';
                    if (rawType.includes('CNC')) celluloseType = 'CNC';
                    else if (rawType.includes('CNF')) celluloseType = 'CNF';
                    
                    let celluloseSource = 'Unknown';
                    const match = rawType.match(/\(([^)]+)\)/);
                    if (match) {
                        celluloseSource = match[1].split(',')[0].replace('from ', '').trim();
                    }
                    
                    // Helper to parse potentially numeric fields with symbols
                    const parseNumeric = (value, median) => {
                        if (value === null || value === undefined) return median;
                        if (typeof value === 'string') {
                            const num = parseFloat(value.replace('>', '').replace('<', ''));
                            return isNaN(num) ? median : num;
                        }
                        return value;
                    };

                    return {
                        ...d,
                        ...pubInfo,
                        Cellulose_Type: celluloseType,
                        Cellulose_Source: celluloseSource,
                        Droplet_Size_um: parseNumeric(d.Droplet_Size_um, medianDroplet),
                        Aspect_Ratio: parseNumeric(d.Aspect_Ratio, medianAspectRatio),
                        // Convert other potentially stringified numbers
                        Particle_L_nm: parseNumeric(d.Particle_L_nm, null),
                        Particle_w_nm: parseNumeric(d.Particle_w_nm, null),
                        Particle_t_nm: parseNumeric(d.Particle_t_nm, null),
                        Surface_Charge_Density_e_nm2: parseNumeric(d.Surface_Charge_Density_e_nm2, null),
                    };
                });
            }
            
            function populateSelectors() {
                const xSelect = document.getElementById('x-axis-select');
                const ySelect = document.getElementById('y-axis-select');
                const colorSelect = document.getElementById('color-by-select');
                const filterCatSelect = document.getElementById('filter-category-select');
                const distCatSelect = document.getElementById('dist-category-select');

                [xSelect, ySelect, colorSelect, filterCatSelect, distCatSelect].forEach(s => s.innerHTML = '');

                numericalCols.forEach(col => {
                    xSelect.add(new Option(col, col));
                    ySelect.add(new Option(col, col));
                });

                categoricalCols.forEach(col => {
                    colorSelect.add(new Option(col, col));
                    filterCatSelect.add(new Option(col, col));
                    distCatSelect.add(new Option(col, col));
                });
                
                xSelect.value = 'Concentration_wt_percent';
                ySelect.value = 'Droplet_Size_um';
                colorSelect.value = 'Cellulose_Type';
                filterCatSelect.value = 'Cellulose_Type';
                distCatSelect.value = 'Cellulose_Type';
                
                updateFilterValueOptions();
            }
            
            function updateFilterValueOptions() {
                const filterCat = document.getElementById('filter-category-select').value;
                const filterValSelect = document.getElementById('filter-value-select');
                filterValSelect.innerHTML = '<option value="All">All</option>';
                
                if (filterCat && processedData.length > 0) {
                    const uniqueValues = [...new Set(processedData.map(d => d[filterCat]))];
                    uniqueValues.sort().forEach(val => {
                        if (val) filterValSelect.add(new Option(val, val));
                    });
                }
            }
            
            function getFilteredData() {
                const filterCat = document.getElementById('filter-category-select').value;
                const filterVal = document.getElementById('filter-value-select').value;
                if (filterVal === 'All' || !filterCat) {
                    return processedData;
                }
                return processedData.filter(d => d[filterCat] == filterVal);
            }

            function updateAllPlots() {
                updateScatterPlot();
                updateDistributionPlot();
                drawHeatmap();
            }

            // --- PLOTTING FUNCTIONS ---
            function updateScatterPlot() {
                const data = getFilteredData();
                const xVar = document.getElementById('x-axis-select').value;
                const yVar = document.getElementById('y-axis-select').value;
                const colorVar = document.getElementById('color-by-select').value;
                const logX = document.getElementById('log-x-checkbox').checked;
                const logY = document.getElementById('log-y-checkbox').checked;

                const traces = [];
                const groups = [...new Set(data.map(d => d[colorVar]))];

                groups.forEach(group => {
                    const groupData = data.filter(d => d[colorVar] === group);
                    traces.push({
                        x: groupData.map(d => d[xVar]),
                        y: groupData.map(d => d[yVar]),
                        customdata: groupData.map(d => d.DOI),
                        text: groupData.map(d => `<b>${d.Title || 'N/A'}</b><br>Authors: ${d.Authors || 'N/A'}<br>Year: ${d.Publication_Year || 'N/A'}<br>DOI: ${d.DOI}<br>--------------------<br>Type: ${d.Cellulose_Type} (${d.Cellulose_Source})<br>Concentration: ${d.Concentration_wt_percent} wt%<br>Aspect Ratio: ${d.Aspect_Ratio}`),
                        hoverinfo: 'text',
                        mode: 'markers',
                        type: 'scatter',
                        name: group || 'N/A',
                        marker: { size: 10, opacity: 0.8 }
                    });
                });

                const layout = {
                    xaxis: { title: xVar, type: logX ? 'log' : 'linear', autorange: true, gridcolor: '#475569', zerolinecolor: '#475569' },
                    yaxis: { title: yVar, type: logY ? 'log' : 'linear', autorange: true, gridcolor: '#475569', zerolinecolor: '#475569' },
                    showlegend: true,
                    legend: { font: { color: '#e2e8f0' }, orientation: 'h', y: -0.2},
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#e2e8f0' },
                    margin: { l: 60, r: 20, b: 60, t: 40 }
                };
                Plotly.newPlot('interactive-scatter', traces, layout, {responsive: true});
            }

            function updateDistributionPlot() {
                const data = getFilteredData();
                const catVar = document.getElementById('dist-category-select').value;

                const traces = [];
                const groups = [...new Set(data.map(d => d[catVar]))].sort();

                groups.forEach(group => {
                    const groupData = data.filter(d => d[catVar] === group);
                    traces.push({
                        y: groupData.map(d => d.Droplet_Size_um),
                        type: 'box',
                        name: group || 'N/A',
                        boxpoints: 'all',
                        jitter: 0.5,
                        pointpos: -1.8,
                    });
                });

                const layout = {
                    yaxis: { title: 'Droplet Size (μm)', zeroline: false, gridcolor: '#475569', type: 'log', autorange: true },
                    xaxis: { title: catVar, tickangle: -45 },
                    showlegend: false,
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#e2e8f0' },
                     margin: { l: 60, r: 20, b: 120, t: 40 },
                     colorway: ['#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A', '#19D3F3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52']
                };
                Plotly.newPlot('distribution-plot', traces, layout, {responsive: true});
            }

            function drawHeatmap() {
                const numData = processedData.map(row => {
                    let newRow = {};
                    numericalCols.forEach(col => {
                        newRow[col] = (row[col] === null || row[col] === undefined) ? NaN : row[col];
                    });
                    return newRow;
                });

                const columns = numericalCols.filter(c => c !== 'Publication_Year');
                const matrix = [];
                for (let i = 0; i < columns.length; i++) {
                    const row = [];
                    for (let j = 0; j < columns.length; j++) {
                        const col1 = numData.map(d => d[columns[i]]);
                        const col2 = numData.map(d => d[columns[j]]);
                        row.push(calculateCorrelation(col1, col2));
                    }
                    matrix.push(row);
                }

                const trace = {
                    z: matrix,
                    x: columns,
                    y: columns,
                    type: 'heatmap',
                    colorscale: 'RdBu',
                    zmin: -1,
                    zmax: 1
                };

                const layout = {
                    title: '',
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#e2e8f0' },
                    xaxis: { tickangle: -45 },
                    margin: { l: 150, r: 20, b: 150, t: 40 }
                };

                Plotly.newPlot('heatmap-plot', [trace], layout, {responsive: true});
            }

            function calculateCorrelation(x, y) {
                const validPairs = x.map((val, i) => [val, y[i]]).filter(([valX, valY]) => !isNaN(valX) && !isNaN(valY));
                if (validPairs.length < 2) return 0;

                const n = validPairs.length;
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
                
                validPairs.forEach(([valX, valY]) => {
                    sumX += valX;
                    sumY += valY;
                    sumXY += valX * valY;
                    sumX2 += valX * valX;
                    sumY2 += valY * valY;
                });

                const num = (n * sumXY) - (sumX * sumY);
                const den = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));
                return den === 0 ? 0 : num / den;
            }

            // --- INITIALIZATION & EVENT LISTENERS ---
            function init() {
                processedData = preprocessData(database, publicationData);
                populateSelectors();
                
                updateAllPlots();

                const scatterPlot = document.getElementById('interactive-scatter');
                scatterPlot.on('plotly_click', function(data) {
                    if (data.points.length > 0) {
                        const point = data.points[0];
                        const doi = point.customdata;
                        if (doi) {
                            let url;
                            if (doi.startsWith('SSRN:')) {
                                const abstractId = doi.replace('SSRN:', '').trim();
                                url = `https://papers.ssrn.com/sol3/papers.cfm?abstract_id=${abstractId}`;
                            } else {
                                url = `https://doi.org/${doi}`;
                            }
                            
                            // Create a temporary link and click it to open in a new tab
                            // This is more robust in sandboxed/iframe environments
                            const link = document.createElement('a');
                            link.href = url;
                            link.target = '_blank';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    }
                });

                document.getElementById('x-axis-select').addEventListener('change', updateScatterPlot);
                document.getElementById('y-axis-select').addEventListener('change', updateScatterPlot);
                document.getElementById('color-by-select').addEventListener('change', updateScatterPlot);
                document.getElementById('filter-category-select').addEventListener('change', () => {
                    updateFilterValueOptions();
                    updateAllPlots();
                });
                document.getElementById('filter-value-select').addEventListener('change', updateAllPlots);
                document.getElementById('log-x-checkbox').addEventListener('change', updateScatterPlot);
                document.getElementById('log-y-checkbox').addEventListener('change', updateScatterPlot);
                document.getElementById('dist-category-select').addEventListener('change', updateDistributionPlot);
            }
            
            init();
        });
    </script>
</body>
</html>

